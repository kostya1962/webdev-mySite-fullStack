# 🏗️ Архитектура системы управления корзиной

## Общая архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                        БРАУЗЕР ПОЛЬЗОВАТЕЛЯ                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │         FRONTEND (Nuxt 3 + Vue 3 + TypeScript)           │   │
│  │                                                           │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │          Pages (Страницы приложения)                │ │   │
│  │  │  ┌──────────────────────────────────────────────┐   │ │   │
│  │  │  │ /catalog/sup-[id].vue (Страница товара)      │   │ │   │
│  │  │  │   - Показывает информацию о товаре           │   │ │   │
│  │  │  │   - Использует компонент AddToCart ↓         │   │ │   │
│  │  │  └──────────────────────────────────────────────┘   │ │   │
│  │  │  ┌──────────────────────────────────────────────┐   │ │   │
│  │  │  │ /cart.vue (Страница корзины)                 │   │ │   │
│  │  │  │   - Загружает cartStore.restore()            │   │ │   │
│  │  │  │   - Отображает товары из store               │   │ │   │
│  │  │  └──────────────────────────────────────────────┘   │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  │                                                           │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │      Components (Vue Компоненты)                    │ │   │
│  │  │  ┌──────────────────────────────────────────────┐   │ │   │
│  │  │  │ AddToCart.vue ⭐ (НОВЫЙ КОМПОНЕНТ)           │   │ │   │
│  │  │  │  Состояние 1: Кнопка "Добавить в корзину"  │   │ │   │
│  │  │  │      ↓ При нажатии                           │   │ │   │
│  │  │  │      Проверка авторизации (authStore.token) │   │ │   │
│  │  │  │      ├─ Не авторизован? → /auth/login       │   │ │   │
│  │  │  │      └─ Авторизован? → Состояние 2           │   │ │   │
│  │  │  │  Состояние 2: Счётчик + Кнопки               │   │ │   │
│  │  │  │      ├─ Кнопка "Удалить" → Состояние 1      │   │ │   │
│  │  │  │      ├─ CounterFiled (счётчик)              │   │ │   │
│  │  │  │      └─ Кнопка "Добавить" → cartStore.add..│   │ │   │
│  │  │  └──────────────────────────────────────────────┘   │ │   │
│  │  │  ┌──────────────────────────────────────────────┐   │ │   │
│  │  │  │ ActionButton.vue (уже существует)            │   │ │   │
│  │  │  │ CounterFiled.vue (уже существует)            │   │ │   │
│  │  │  └──────────────────────────────────────────────┘   │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  │                                                           │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │   State Management (Pinia Stores)                   │ │   │
│  │  │  ┌──────────────────────────────────────────────┐   │ │   │
│  │  │  │ cartStore (cart.state.ts) ⭐ НОВЫЙ STORE     │   │ │   │
│  │  │  │  ┌─────────────────────────────────────────┐ │   │ │   │
│  │  │  │  │ State:                                  │ │   │ │   │
│  │  │  │  │ - cartItems: CartItem[]                 │ │   │ │   │
│  │  │  │  └─────────────────────────────────────────┘ │   │ │   │
│  │  │  │  ┌─────────────────────────────────────────┐ │   │ │   │
│  │  │  │  │ Actions:                                │ │   │ │   │
│  │  │  │  │ - addToCart()                           │ │   │ │   │
│  │  │  │  │ - removeFromCart()                      │ │   │ │   │
│  │  │  │  │ - updateQuantity()                      │ │   │ │   │
│  │  │  │  │ - clearCart()                           │ │   │ │   │
│  │  │  │  │ - getQuantity()                         │ │   │ │   │
│  │  │  │  │ - getTotalPrice()                       │ │   │ │   │
│  │  │  │  │ - getItemsCount()                       │ │   │ │   │
│  │  │  │  │ - restore(email)                        │ │   │ │   │
│  │  │  │  │ - save(productId, quantity)             │ │   │ │   │
│  │  │  │  └─────────────────────────────────────────┘ │   │ │   │
│  │  │  └──────────────────────────────────────────────┘   │ │   │
│  │  │  ┌──────────────────────────────────────────────┐   │ │   │
│  │  │  │ authStore (auth.state.ts) (существует)      │   │ │   │
│  │  │  │ - token                                      │   │ │   │
│  │  │  │ - email                                      │   │ │   │
│  │  │  └──────────────────────────────────────────────┘   │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  │                                                           │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │  Interfaces (TypeScript типы)                        │ │   │
│  │  │  ┌──────────────────────────────────────────────┐   │ │   │
│  │  │  │ cart.interface.ts ⭐ НОВЫЕ ИНТЕРФЕЙСЫ       │   │ │   │
│  │  │  │ - CartItem { product, quantity }            │   │ │   │
│  │  │  │ - Cart { items, totalPrice }                │   │ │   │
│  │  │  │ - AddToCartRequest                          │   │ │   │
│  │  │  │ - CartResponse                              │   │ │   │
│  │  │  └──────────────────────────────────────────────┘   │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  │                                                           │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │      Local Storage (Персистентность)               │ │   │
│  │  │  ┌──────────────────────────────────────────────┐   │ │   │
│  │  │  │ Key: "cart"                                 │   │ │   │
│  │  │  │ Value: {cartItems: [{product, quantity}]}  │   │ │   │
│  │  │  │ ⚡ Автоматическое сохранение (persist)     │   │ │   │
│  │  │  └──────────────────────────────────────────────┘   │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  └───────────────────────────────────┬─────────────────────┘   │
│                                       │                         │
└───────────────────────────────────────┼─────────────────────────┘
                                        │
                    ┌───────────────────┼────────────────────┐
                    │ INTERNET (HTTP)   │                    │
                    │                   │                    │
                    ▼                   ▼                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    BACKEND (Go + Fiber)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │              API Endpoints (main.go)                      │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ /api/cart (Group Routes)                            │ │ │
│  │  │  POST /api/cart        → handlers.AddToCart()       │ │ │
│  │  │  GET  /api/cart        → handlers.GetCart()         │ │ │
│  │  │  DELETE /api/cart      → handlers.RemoveFromCart()  │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────┬───────────────────────────────┘ │
│                              │                                 │
│  ┌───────────────────────────┼───────────────────────────────┐ │
│  │         Handlers (cart.go) ⭐ НОВЫЕ ОБРАБОТЧИКИ          │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ AddToCart(c *fiber.Ctx)                             │ │ │
│  │  │  1. Parse JSON {email, productID, quantity}         │ │ │
│  │  │  2. Проверить существование пользователя (users)   │ │ │
│  │  │  3. Проверить существование товара (products)      │ │ │
│  │  │  4. Проверить наличие в cart_items                 │ │ │
│  │  │  5. INSERT или UPDATE в базу                        │ │ │
│  │  │  6. Вернуть успех {success: true}                  │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ GetCart(c *fiber.Ctx)                               │ │ │
│  │  │  1. Get email из query параметров                  │ │ │
│  │  │  2. SELECT cart_items JOIN products                │ │ │
│  │  │  3. Вернуть массив {product, quantity}             │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ RemoveFromCart(c *fiber.Ctx)                        │ │ │
│  │  │  1. Parse JSON {email, productID}                   │ │ │
│  │  │  2. DELETE FROM cart_items WHERE ...                │ │ │
│  │  │  3. Вернуть успех {success: true}                  │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────┬───────────────────────────────┘ │
│                              │                                 │
│  ┌───────────────────────────┼───────────────────────────────┐ │
│  │      Database (SQLite)     │ ⭐ ТАБЛИЦА ОБНОВЛЕНА          │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ cart_items TABLE                                    │ │ │
│  │  │ ┌─────────────┬──────────┬─────────────────────┐   │ │ │
│  │  │ │ id (PK)     │ user_id  │ product_id          │   │ │ │
│  │  │ │ quantity    │ FK→users │ FK→products         │   │ │ │
│  │  │ │ created_at  │ updated_at                      │   │ │ │
│  │  │ │ UNIQUE(user_id, product_id)                  │   │ │ │
│  │  │ └─────────────┴──────────┴─────────────────────┘   │ │ │
│  │  │                                                     │ │ │
│  │  │ Связанные таблицы:                                 │ │ │
│  │  │ - users (id, email, password, ...)                 │ │ │
│  │  │ - products (id, name, price, ...)                  │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## Поток данных: Добавление товара в корзину

```
USER INTERACTION
       │
       ▼
┌─────────────────────────────────┐
│ Нажимает кнопку                 │
│ "Добавить в корзину"            │
└─────────────────┬───────────────┘
                  │
                  ▼
        ┌─────────────────────┐
        │ AddToCart.vue       │
        │ handleAddClick()    │
        └─────────┬───────────┘
                  │
                  ▼
        ┌─────────────────────────────┐
        │ Авторизован?                │
        │ authStore.token есть?       │
        └─────┬───────────────┬───────┘
              │ НЕТ           │ ДА
              ▼               ▼
        /auth/login      Счётчик видимости
        (редирект)           │
                              ▼
                      ┌──────────────────┐
                      │ Пользователь     │
                      │ выбирает кол-во  │
                      │ CounterFiled     │
                      └────────┬─────────┘
                               │
                      Нажимает "Добавить"
                               │
                               ▼
                      ┌──────────────────────┐
                      │ cartStore.addToCart()│
                      └──────┬───────────────┘
                             │
                  ┌──────────┴──────────┐
                  │                     │
                  ▼                     ▼
          ┌─────────────────┐  ┌──────────────────┐
          │ localStorage    │  │ POST /api/cart   │
          │ ("cart")        │  │ (если auth)      │
          └─────────────────┘  └────────┬─────────┘
                                        │
                                        ▼
                                ┌──────────────────┐
                                │ Backend:         │
                                │ AddToCart()      │
                                │ handlers         │
                                └────────┬─────────┘
                                         │
                         ┌───────────────┼──────────────┐
                         │               │              │
                         ▼               ▼              ▼
                    Проверки      DB Query:      Ответ:
                    - user        INSERT или     200 OK
                    - product     UPDATE         + success
                    - ...         cart_items     + data
                                      │
                                      ▼
                            ┌──────────────────┐
                            │ cart_items       │
                            │ обновлена ✅     │
                            └──────────────────┘
                                      │
                                      └──→ Response → Browser → cartStore обновляется
                                              │
                                              ▼
                                      ┌──────────────────────┐
                                      │ Компонент обновляется│
                                      │ Возврат в режим 1    │
                                      │ Товар добавлен ✅    │
                                      └──────────────────────┘
```

---

## Синхронизация между браузером и сервером

```
БРАУЗЕР                        СЕРВЕР (БД)
   │                               │
   │ 1. Пользователь добавляет     │
   │    товар в корзину            │
   │                               │
   │ 2. cartStore.addToCart()      │
   │    ├─ localStorage ✓          │
   │    └─ POST /api/cart ────────→│
   │                               │
   │                               │ 3. INSERT/UPDATE
   │                               │    cart_items
   │                               │    (user_id, product_id, quantity)
   │                               │
   │←──── 200 OK {"success": true}──│
   │                               │
   │ 4. Компонент обновляется      │
   │                               │
   │ ─────────────────────────────────
   │ Пользователь закрывает браузер
   │ ─────────────────────────────────
   │                               │
   │ 5. Пользователь открывает     │
   │    браузер снова              │
   │                               │
   │ 6. cartStore.restore(email)   │
   │    GET /api/cart?email=... ──→│
   │                               │
   │                               │ 7. SELECT * FROM cart_items
   │                               │    WHERE user_id = ...
   │                               │    JOIN products
   │                               │
   │←──── [{product, quantity}, ...│
   │                               │
   │ 8. Корзина восстановлена! ✅  │
   │    (товары видны как раньше)  │
   │                               │
```

---

## Состояния компонента AddToCart

```
STATE 1: INITIAL / UNAUTHORIZED
┌──────────────────────────────┐
│  Добавить в корзину          │
│  (ActionButton - черная)     │
└───────────┬──────────────────┘
            │
    ┌───────┴───────┐
    │               │
    NO REDIR        YES SHOW
    AUTH? /auth     STATE 2
         /login
         
STATE 2: AUTHORIZED / QUANTITY SELECTION
┌─────────┬────────────┬────────┐
│ Удалить │ Счётчик    │Добавить│
│ (серая) │(CountField)│(черная)│
└────┬────┴────────────┴────┬───┘
     │                      │
   CLICK                   CLICK
     │                      │
  HIDE                    SAVE &
  STATE 2                 RESET
  (BACK TO                STATE 1
   STATE 1)               + localStorage
                          + POST /api/cart
```

---

## Функции компонента AddToCart

```
AddToCart.vue
│
├─ Props
│  └─ product: Product
│
├─ Refs
│  ├─ isAdded: boolean (режим: кнопка или счётчик)
│  └─ quantity: number
│
├─ Computed
│  └─ нет (используются store функции)
│
├─ Methods
│  ├─ handleAddClick()
│  │  ├─ Проверка authStore.token
│  │  ├─ Редирект если не авторизован
│  │  └─ Переключение режима если авторизован
│  │
│  ├─ handleConfirmAdd()
│  │  ├─ cartStore.addToCart(product, quantity)
│  │  ├─ Возврат в режим 1
│  │  └─ Reset quantity = 1
│  │
│  └─ handleQuantityChange(newQuantity)
│     └─ quantity.value = newQuantity
│
└─ Emit
   └─ нет (используется store для коммуникации)
```

---

## Store методы и их назначение

```
cartStore = useCartStore()

ДОБАВЛЕНИЕ И УДАЛЕНИЕ:
├─ addToCart(product, quantity)
│  └─ Добавляет товар или увеличивает количество
│
├─ removeFromCart(productId)
│  └─ Удаляет товар полностью
│
├─ updateQuantity(productId, quantity)
│  └─ Изменяет количество товара
│
└─ clearCart()
   └─ Очищает всю корзину

ПОЛУЧЕНИЕ ДАННЫХ:
├─ getQuantity(productId): number
│  └─ Количество конкретного товара
│
├─ getTotalPrice(): number
│  └─ Сумма всех товаров
│
└─ getItemsCount(): number
   └─ Количество товаров (сумма всех quantities)

СИНХРОНИЗАЦИЯ С СЕРВЕРОМ:
├─ restore(email): Promise
│  └─ Загружает корзину с сервера
│
└─ save(productId, quantity): Promise
   └─ Сохраняет товар на сервере
```

---

## API запросы и ответы

```
REQUEST 1: Добавить товар
───────────────────────────
POST /api/cart
{
  "email": "user@example.com",
  "productID": 1,
  "quantity": 2
}

RESPONSE:
{
  "success": true,
  "message": "Item added to cart"
}

─────────────────────────────────────

REQUEST 2: Получить корзину
───────────────────────────
GET /api/cart?email=user@example.com

RESPONSE:
[
  {
    "product": {
      "id": 1,
      "name": "Кольцо",
      "price": 12999,
      ...
    },
    "quantity": 2
  },
  {
    "product": { ... },
    "quantity": 1
  }
]

─────────────────────────────────────

REQUEST 3: Удалить товар
───────────────────────────
DELETE /api/cart
{
  "email": "user@example.com",
  "productID": 1
}

RESPONSE:
{
  "success": true,
  "message": "Item removed from cart"
}
```

---

## Порядок инициализации при загрузке страницы

```
1. Nuxt инициализирует приложение
   │
2. localStorage восстанавливается
   ├─ cartStore инициализируется с сохраненными данными
   └─ authStore инициализируется с сохраненным токеном
   │
3. Пользователь авторизован?
   ├─ ДА: cartStore.restore(email)
   │   └─ GET /api/cart → обновляет локальное состояние
   │
   └─ НЕТ: Корзина остается пустой/с локальными данными
   │
4. Страница отрисовывается
   └─ Компоненты имеют доступ к актуальным данным cartStore
```

---

## Обработка ошибок

```
┌─────────────────────┐
│ API запрос          │
└──────────┬──────────┘
           │
     ┌─────┴──────┐
     │            │
  SUCCESS       ERROR
     │            │
     ▼            ▼
  200 OK     400/404/500
     │            │
 SAVE TO      CATCH BLOCK
 localStorage    │
     │           ▼
     │      console.error()
     │      (+ UI уведомление)
     │
     └─→ cartStore обновляется
```

